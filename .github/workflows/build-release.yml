name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Calculate version and prepare release
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      should_release: ${{ steps.check_release.outputs.should_release }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0  # Fetch all history for commit counting
      
      - name: Calculate version
        id: version
        run: |
          chmod +x scripts/calculate-version.sh
          VERSION=$(scripts/calculate-version.sh)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Calculated version: $VERSION"
      
      - name: Check if release needed
        id: check_release
        run: |
          # Only create release on main branch pushes (not PRs)
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # Build for Windows
  build-windows:
    name: Build Windows (MSI/EXE)
    needs: prepare-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@76a93fbab609abe90979db006858b656ceb1c584
        with:
          targets: x86_64-pc-windows-msvc
      
      - name: Install WebView2
        run: |
          # Check if WebView2 is already installed
          if (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\EdgeUpdate\ClientState\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}" -ErrorAction SilentlyContinue) {
            Write-Host "WebView2 Runtime is already installed"
          } else {
            Write-Host "Installing WebView2 Runtime..."
            # Download and install WebView2 runtime
            $url = "https://go.microsoft.com/fwlink/p/?LinkId=2124703"
            $output = "$env:TEMP\MicrosoftEdgeWebview2Setup.exe"
            Invoke-WebRequest -Uri $url -OutFile $output
            Start-Process -FilePath $output -ArgumentList "/silent", "/install" -Wait
            Remove-Item $output
          }
      
      - name: Build release
        run: |
          cargo build --release --target x86_64-pc-windows-msvc
      
      - name: Create MSI installer
        shell: pwsh
        run: |
          # Install WiX Toolset for MSI creation
          choco install wixtoolset -y
          
          # Create basic WiX project structure
          New-Item -ItemType Directory -Force -Path "packaging\windows\msi"
          
          # Create a simple WiX source file (this would be expanded in a real implementation)
          $wxsContent = @'
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
              <Product Id="*" Name="WebX Browser" Language="1033" Version="1.0.0.0" 
                       Manufacturer="Ledokoz" UpgradeCode="12345678-1234-1234-1234-123456789012">
                  <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
                  
                  <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
                  <MediaTemplate />
                  
                  <Feature Id="ProductFeature" Title="WebX Browser" Level="1">
                      <ComponentGroupRef Id="ProductComponents" />
                  </Feature>
              </Product>
              
              <Fragment>
                  <Directory Id="TARGETDIR" Name="SourceDir">
                      <Directory Id="ProgramFilesFolder">
                          <Directory Id="INSTALLFOLDER" Name="WebX" />
                      </Directory>
                  </Directory>
              </Fragment>
              
              <Fragment>
                  <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
                      <Component Id="MainExecutable" Guid="*">
                          <File Id="WebXExe" Name="webx.exe" Source="target\x86_64-pc-windows-msvc\release\webx.exe" KeyPath="yes" />
                      </Component>
                  </ComponentGroup>
              </Fragment>
          </Wix>
          '@
          
          Set-Content -Path "packaging\windows\msi\webx.wxs" -Value $wxsContent
          
          # Build MSI
          Set-Location "packaging\windows\msi"
          candle webx.wxs
          light webx.wixobj
      
      - name: Package artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "artifacts"
          Copy-Item "target\x86_64-pc-windows-msvc\release\webx.exe" "artifacts\webx-${{ needs.prepare-release.outputs.version }}-windows-x64.exe"
          Copy-Item "packaging\windows\msi\webx.msi" "artifacts\webx-${{ needs.prepare-release.outputs.version }}-windows-x64.msi"
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: windows-artifacts
          path: artifacts/

  # Build for Linux
  build-linux:
    name: Build Linux (DEB/AppImage)
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            librsvg2-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@76a93fbab609abe90979db006858b656ceb1c584
        with:
          targets: x86_64-unknown-linux-gnu
      
      - name: Build release
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu
      
      - name: Create DEB package
        run: |
          # Create artifacts directory
          mkdir -p artifacts
          
          # Create Debian package structure
          mkdir -p packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/usr/bin
          mkdir -p packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/usr/share/applications
          mkdir -p packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/usr/share/icons/hicolor/256x256/apps
          mkdir -p packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/DEBIAN
          
          # Copy binary
          cp target/x86_64-unknown-linux-gnu/release/webx packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/usr/bin/
          
          # Create desktop entry
          cat > packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/usr/share/applications/webx.desktop << 'EOF'
          [Desktop Entry]
          Name=WebX Browser
          Comment=Official system browser for Ledokoz OS
          Exec=/usr/bin/webx %u
          Icon=webx
          Terminal=false
          Type=Application
          Categories=Network;WebBrowser;
          MimeType=text/html;text/xml;application/xhtml+xml;application/xml;application/rss+xml;x-scheme-handler/http;x-scheme-handler/https;
          EOF
          
          # Create control file
          cat > packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64/DEBIAN/control << EOF
          Package: webx
          Version: ${{ needs.prepare-release.outputs.version }}
          Section: web
          Priority: optional
          Architecture: amd64
          Maintainer: Ledokoz Team <contact@ledokoz.com>
          Description: WebX Browser - Official system browser for Ledokoz OS
           Built with Rust for security, performance, and native integration.
          Depends: libwebkit2gtk-4.1-0, libgtk-3-0, libssl3
          EOF
          
          # Build DEB
          dpkg-deb --build packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64
          mv packaging/debian/webx_${{ needs.prepare-release.outputs.version }}_amd64.deb artifacts/webx-${{ needs.prepare-release.outputs.version }}-linux-amd64.deb
      
      # - name: Create AppImage
      #   run: |
      #     # Create artifacts directory
      #     mkdir -p artifacts
      #     
      #     # Download linuxdeploy
      #     echo "Downloading linuxdeploy..."
      #     wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
      #     echo "Downloading linuxdeploy-plugin-gtk..."
      #     wget -O linuxdeploy-plugin-gtk https://github.com/linuxdeploy/linuxdeploy-plugin-gtk/releases/download/continuous/linuxdeploy-plugin-gtk.sh
      #     chmod +x linuxdeploy linuxdeploy-plugin-gtk
      #     
      #     # Creating the AppDir structure
      #     echo "Creating the AppDir structure..."
      #     mkdir -p AppDir/usr/bin
      #     cp target/x86_64-unknown-linux-gnu/release/webx AppDir/usr/bin/
      #     
      #     # Create desktop file
      #     cat > AppDir/webx.desktop << 'EOF'
      #     [Desktop Entry]
      #     Name=WebX Browser
      #     Exec=webx
      #     Type=Application
      #     Categories=Network;WebBrowser;
      #     EOF
      #     
      #     # Create AppRun script
      #     cat > AppDir/AppRun << 'EOF'
      #     #!/bin/bash
      #     HERE="$(dirname "$(readlink -f "${0}")")"
      #     export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
      #     exec "${HERE}/usr/bin/webx" "$@"
      #     EOF
      #     chmod +x AppDir/AppRun
      #     
      #     # Building the AppImage using linuxdeploy
      #     echo "Building the AppImage using linuxdeploy..."
      #     ./linuxdeploy --appdir AppDir --plugin gtk --output appimage
      #     
      #     # Moving the final AppImage to the artifacts directory
      #     echo "Moving the final AppImage to the artifacts directory..."
      #     mv WebX*.AppImage artifacts/webx-${{ needs.prepare-release.outputs.version }}-linux-amd64.AppImage
      
      - name: Package standalone binary
        run: |
          mkdir -p artifacts
          cp target/x86_64-unknown-linux-gnu/release/webx artifacts/webx-${{ needs.prepare-release.outputs.version }}-linux-amd64
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: linux-artifacts
          path: artifacts/

  # Build for macOS
  build-macos:
    name: Build macOS (DMG/App)
    needs: prepare-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@76a93fbab609abe90979db006858b656ceb1c584
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin
      
      - name: Build for Intel Mac
        run: |
          cargo build --release --target x86_64-apple-darwin
      
      - name: Build for Apple Silicon
        run: |
          cargo build --release --target aarch64-apple-darwin
      
      - name: Create Universal Binary
        run: |
          # Create universal binary using lipo
          lipo -create -output target/release/webx-universal \
            target/x86_64-apple-darwin/release/webx \
            target/aarch64-apple-darwin/release/webx
      
      - name: Create macOS App Bundle
        run: |
          # Create app bundle structure
          mkdir -p WebX.app/Contents/MacOS
          mkdir -p WebX.app/Contents/Resources
          
          # Copy binary
          cp target/release/webx-universal WebX.app/Contents/MacOS/WebX
          
          # Create Info.plist
          cat > WebX.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>WebX</string>
              <key>CFBundleDisplayName</key>
              <string>WebX Browser</string>
              <key>CFBundleIdentifier</key>
              <string>com.ledokoz.webx</string>
              <key>CFBundleVersion</key>
              <string>${{ needs.prepare-release.outputs.version }}</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ needs.prepare-release.outputs.version }}</string>
              <key>CFBundleExecutable</key>
              <string>WebX</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon.icns</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # Make executable
          chmod +x WebX.app/Contents/MacOS/WebX
          
          # Verify the app bundle was created
          ls -la WebX.app/
          ls -la WebX.app/Contents/
          ls -la WebX.app/Contents/MacOS/
      
      - name: Create DMG
        run: |
          # Create artifacts directory
          mkdir -p artifacts
          
          # Create DMG
          hdiutil create -volname "WebX Browser" -srcfolder WebX.app -ov -format UDZO artifacts/webx-${{ needs.prepare-release.outputs.version }}-macos-universal.dmg
      
      - name: Package artifacts
        run: |
          # Ensure artifacts directory exists
          mkdir -p artifacts
          
          # Copy universal binary
          cp target/release/webx-universal artifacts/webx-${{ needs.prepare-release.outputs.version }}-macos-universal
          
          # Copy app bundle if it exists
          if [ -d "WebX.app" ]; then
            cp -r WebX.app artifacts/
          else
            echo "Warning: WebX.app not found"
          fi
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: macos-artifacts
          path: artifacts/

  # Android build (APK)
  build-android:
    name: Build Android (APK)
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
      - name: Set up JDK 17
        uses: actions/setup-java@387ac29b308b003ca37ba93a6cab9883541433a3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Install Android SDK
        uses: android-actions/setup-android@5e376988bef97ec5e8d7e642a1e55922d1b4475f
      
      - name: Install Rust with Android targets
        run: |
          rustup target add \
            aarch64-linux-android \
            armv7-linux-androideabi \
            x86_64-linux-android \
            i686-linux-android
      
      - name: Install cargo-ndk
        run: |
          cargo install cargo-ndk
      
      - name: Build for Android
        run: |
          # This is a placeholder - actual Android build would require:
          # 1. Android NDK setup
          # 2. JNI bindings
          # 3. Android project structure
          # 4. Proper WebView integration
          
          echo "Android build placeholder - would build APK here"
          mkdir -p artifacts
          touch artifacts/webx-${{ needs.prepare-release.outputs.version }}-android.apk
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: android-artifacts
          path: artifacts/

  # Create release
  create-release:
    name: Create GitHub Release
    needs: [prepare-release, build-windows, build-linux, build-macos, build-android]
    runs-on: ubuntu-latest
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          path: downloaded-artifacts
      
      - name: Flatten artifact structure
        run: |
          mkdir -p release-assets
          find downloaded-artifacts -type f -exec cp {} release-assets/ \;
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844
        with:
          name: WebX Browser ${{ needs.prepare-release.outputs.version }}
          tag_name: ${{ needs.prepare-release.outputs.version }}
          body: |
            ## WebX Browser ${{ needs.prepare-release.outputs.version }}
            
            Official system browser for Ledokoz OS
            
            ### What's New
            - Automated build and release pipeline
            - Multi-platform support (Windows, Linux, macOS, Android)
            - Commit-count based versioning system
            
            ### Downloads
            - **Windows**: MSI installer and standalone EXE
            - **Linux**: DEB package, AppImage, and standalone binary
            - **macOS**: DMG installer and universal binary
            - **Android**: APK (experimental)
            
            ### Installation
            Download the appropriate package for your platform and follow the installation instructions.
            
            ### Commit Count Versioning
            This release uses commit-count based versioning:
            - 1 commit = 0.0.001
            - 10 commits = 0.0.01
            - 100 commits = 0.0.1
            - 1,000 commits = 0.1.0
            - 10,000 commits = 1.0.0
            
            Current commit count: $(git rev-list --count HEAD)
          draft: false
          prerelease: false
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}